<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CENTRABIO R&D NEXUS - Scientific Decision Support System">
    <meta name="theme-color" content="#1a5f2a">
    <title>CENTRABIO R&D NEXUS</title>
    <link rel="icon" type="image/png" href="/logo-only.png">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Excel Export Library -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1a5f2a; --primary-light: #2d8c3f; --primary-dark: #0d4a1a;
            --secondary: #f0a500; --accent: #00bcd4;
            --success: #4caf50; --warning: #ff9800; --danger: #f44336; --info: #2196f3;
            --bg-primary: #0a1612; --bg-secondary: #121f1a; --bg-tertiary: #1a2f25; --bg-card: #162520;
            --text-primary: #e8f5e9; --text-secondary: #a5d6a7; --text-muted: #6b8f70;
            --border: #2d4f3a; --border-light: #3d6f4a;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
            --radius: 10px; --radius-lg: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-secondary); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        .app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .sidebar-header img { width: 40px; height: 40px; border-radius: 8px; }
        .brand-name { font-weight: 700; font-size: 14px; color: var(--text-primary); }
        .brand-subtitle { font-size: 11px; color: var(--text-muted); }
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 0; }
        .nav-section { padding: 8px 16px; }
        .nav-section-title { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; letter-spacing: 0.5px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 16px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; margin: 2px 8px; cursor: pointer; transition: all 0.2s; }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item i { width: 20px; text-align: center; }
        
        /* Main Content */
        .main-content { flex: 1; margin-left: 260px; display: flex; flex-direction: column; min-height: 100vh; }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .page-title { font-size: 20px; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .user-menu { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; }
        .user-menu:hover { background: var(--bg-tertiary); }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .page-content { flex: 1; padding: 24px; overflow-y: auto; }
        
        /* Cards & UI */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px; }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .card-title i { color: var(--primary-light); }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 12px; }
        .stat-icon.green { background: rgba(76, 175, 80, 0.15); color: var(--success); }
        .stat-icon.blue { background: rgba(33, 150, 243, 0.15); color: var(--info); }
        .stat-icon.orange { background: rgba(255, 152, 0, 0.15); color: var(--warning); }
        .stat-icon.purple { background: rgba(156, 39, 176, 0.15); color: #9c27b0; }
        
        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; transition: all 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26, 95, 42, 0.2); }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-lg { padding: 14px 28px; font-size: 16px; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); background: var(--bg-tertiary); }
        tr:hover { background: var(--bg-tertiary); }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
        .badge-primary { background: rgba(26, 95, 42, 0.2); color: var(--primary-light); }
        .badge-success { background: rgba(76, 175, 80, 0.2); color: var(--success); }
        .badge-warning { background: rgba(255, 152, 0, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(244, 67, 54, 0.2); color: var(--danger); }
        .badge-info { background: rgba(33, 150, 243, 0.2); color: var(--info); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 4px; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { color: var(--text-secondary); margin-bottom: 8px; }
        
        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        
        /* Login */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); }
        .login-card { width: 100%; max-width: 440px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 48px; }
        .login-header { text-align: center; margin-bottom: 40px; }
        .login-header img { max-width: 260px; margin-bottom: 16px; }
        .login-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .login-subtitle { color: var(--text-muted); font-size: 14px; }
        
        /* Alerts */
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .alert-danger { background: rgba(244, 67, 54, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .alert-success { background: rgba(76, 175, 80, 0.1); border: 1px solid var(--success); color: var(--success); }
        .alert-info { background: rgba(33, 150, 243, 0.1); border: 1px solid var(--info); color: var(--info); }
        
        /* Chat */
        .chat-container { position: fixed; bottom: 20px; right: 20px; z-index: 1500; }
        .chat-toggle { width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: white; border: none; cursor: pointer; font-size: 24px; box-shadow: var(--shadow); }
        .chat-window { position: absolute; bottom: 70px; right: 0; width: 380px; height: 500px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); display: flex; flex-direction: column; overflow: hidden; }
        .chat-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; }
        .chat-message { margin-bottom: 12px; }
        .chat-message.user { text-align: right; }
        .chat-message .bubble { display: inline-block; padding: 10px 14px; border-radius: 12px; max-width: 80%; }
        .chat-message.user .bubble { background: var(--primary); color: white; }
        .chat-message.ai .bubble { background: var(--bg-tertiary); }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .chat-input-area input { flex: 1; }
        
        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Skeleton Loading */
        .skeleton { background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-card) 50%, var(--bg-tertiary) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        .skeleton-text { height: 14px; margin-bottom: 8px; }
        .skeleton-title { height: 20px; width: 60%; margin-bottom: 12px; }
        .skeleton-card { height: 100px; border-radius: var(--radius); }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .toast { padding: 14px 20px; border-radius: var(--radius); display: flex; align-items: flex-start; gap: 12px; animation: slideInRight 0.3s ease, fadeOut 0.3s ease 4.7s forwards; box-shadow: var(--shadow); }
        .toast-success { background: rgba(76, 175, 80, 0.95); color: white; border-left: 4px solid #2e7d32; }
        .toast-error { background: rgba(244, 67, 54, 0.95); color: white; border-left: 4px solid #c62828; }
        .toast-warning { background: rgba(255, 152, 0, 0.95); color: white; border-left: 4px solid #ef6c00; }
        .toast-info { background: rgba(33, 150, 243, 0.95); color: white; border-left: 4px solid #1565c0; }
        .toast-icon { font-size: 18px; flex-shrink: 0; margin-top: 2px; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .toast-message { font-size: 13px; opacity: 0.9; }
        .toast-close { background: none; border: none; color: white; opacity: 0.7; cursor: pointer; font-size: 16px; padding: 0; margin-left: 8px; }
        .toast-close:hover { opacity: 1; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }
        
        /* Table Pagination */
        .pagination { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-top: 1px solid var(--border); margin-top: 16px; }
        .pagination-info { font-size: 13px; color: var(--text-muted); }
        .pagination-controls { display: flex; align-items: center; gap: 8px; }
        .pagination-btn { padding: 8px 12px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .pagination-btn:hover:not(:disabled) { background: var(--primary); border-color: var(--primary); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-btn.active { background: var(--primary); border-color: var(--primary); }
        .page-size-select { padding: 8px 12px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 6px; font-size: 13px; }
        
        /* Table Sorting */
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { color: var(--primary-light); }
        .sort-icon { margin-left: 6px; font-size: 10px; opacity: 0.5; }
        .sort-icon.active { opacity: 1; color: var(--primary-light); }
        
        /* Search/Filter Bar */
        .table-toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 12px; flex-wrap: wrap; }
        .search-box { position: relative; flex: 1; max-width: 300px; }
        .search-box input { width: 100%; padding: 10px 16px 10px 40px; }
        .search-box i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .toolbar-actions { display: flex; gap: 8px; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .form-row { grid-template-columns: 1fr; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body x-data="app()" x-init="init()">
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Login Page -->
    <template x-if="!isAuthenticated">
        <div class="login-container">
            <div class="login-card fade-in">
                <div class="login-header">
                    <img src="/cbi-logo-long.png" alt="CentraBio Tech Indonesia">
                    <h1 class="login-title">R&D NEXUS</h1>
                    <p class="login-subtitle">Scientific Decision Support System</p>
                </div>
                <form @submit.prevent="login">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" x-model="credentials.email" placeholder="you@centrabiotechindonesia.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" x-model="credentials.password" placeholder="••••••••" required>
                    </div>
                    <div x-show="loginError" class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        <span x-text="loginError"></span>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%; justify-content: center;" :disabled="isLoading">
                        <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                        <span x-text="isLoading ? 'Signing in...' : 'Sign In'"></span>
                    </button>
                    <div style="margin-top: 20px; padding: 16px; background: rgba(26,95,42,0.1); border-radius: 8px; border: 1px dashed var(--border);">
                        <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;"><i class="fas fa-info-circle"></i> Demo Credentials:</p>
                        <p style="font-size: 11px; color: var(--text-secondary);">Email: <code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 4px;">admin@centrabiotechindonesia.com</code></p>
                        <p style="font-size: 11px; color: var(--text-secondary);">Password: <code style="background: var(--bg-primary); padding: 2px 6px; border-radius: 4px;">Demo@2026!</code></p>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <!-- Main Application -->
    <template x-if="isAuthenticated">
        <div class="app-container">
            <!-- Sidebar -->
            <aside class="sidebar" :class="{ 'open': sidebarOpen }">
                <div class="sidebar-header">
                    <img src="/logo-only.png" alt="Logo">
                    <div>
                        <div class="brand-name">CENTRABIO</div>
                        <div class="brand-subtitle">R&D NEXUS</div>
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Overview</div>
                        <a class="nav-item" :class="{ 'active': currentPage === 'dashboard' }" @click="navigate('dashboard')">
                            <i class="fas fa-chart-line"></i><span>Dashboard</span>
                        </a>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">Research</div>
                        <a class="nav-item" :class="{ 'active': currentPage === 'projects' }" @click="navigate('projects')">
                            <i class="fas fa-flask"></i><span>Projects</span>
                        </a>
                        <a class="nav-item" :class="{ 'active': currentPage === 'formulas' }" @click="navigate('formulas')">
                            <i class="fas fa-prescription-bottle"></i><span>Formulas</span>
                        </a>
                        <a class="nav-item" :class="{ 'active': currentPage === 'lab-tests' }" @click="navigate('lab-tests')">
                            <i class="fas fa-vial"></i><span>Lab Tests</span>
                        </a>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">Field Operations</div>
                        <a class="nav-item" :class="{ 'active': currentPage === 'monitoring' }" @click="navigate('monitoring')">
                            <i class="fas fa-leaf"></i><span>Monitoring</span>
                        </a>
                        <a class="nav-item" :class="{ 'active': currentPage === 'qr-scanner' }" @click="navigate('qr-scanner')">
                            <i class="fas fa-qrcode"></i><span>QR Scanner</span>
                        </a>
                    </div>
                    <div class="nav-section">
                        <div class="nav-section-title">Analytics</div>
                        <a class="nav-item" :class="{ 'active': currentPage === 'analysis' }" @click="navigate('analysis')">
                            <i class="fas fa-brain"></i><span>AI Analysis</span>
                        </a>
                        <a class="nav-item" :class="{ 'active': currentPage === 'reports' }" @click="navigate('reports')">
                            <i class="fas fa-file-pdf"></i><span>Reports</span>
                        </a>
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <header class="header">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button class="btn btn-secondary btn-sm" @click="sidebarOpen = !sidebarOpen" style="display: none;" id="menuBtn">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="page-title" x-text="pageTitle"></h1>
                    </div>
                    <div class="header-actions">
                        <div class="user-menu" @click="logout()">
                            <div class="user-avatar" x-text="user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U'"></div>
                            <div>
                                <div style="font-size: 14px; font-weight: 500;" x-text="user.full_name || 'User'"></div>
                                <div style="font-size: 11px; color: var(--text-muted);" x-text="formatRole(user.role)"></div>
                            </div>
                            <i class="fas fa-sign-out-alt" style="color: var(--text-muted);"></i>
                        </div>
                    </div>
                </header>

                <div class="page-content">
                    <!-- Dashboard -->
                    <template x-if="currentPage === 'dashboard'">
                        <div class="fade-in">
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-icon green"><i class="fas fa-flask"></i></div>
                                    <div class="stat-value" x-text="stats.activeProjects"></div>
                                    <div class="stat-label">Active Projects</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon orange"><i class="fas fa-clock"></i></div>
                                    <div class="stat-value" x-text="stats.pendingQC"></div>
                                    <div class="stat-label">Pending QC</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon blue"><i class="fas fa-clipboard-list"></i></div>
                                    <div class="stat-value" x-text="stats.observations"></div>
                                    <div class="stat-label">Total Observations</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-icon purple"><i class="fas fa-check-circle"></i></div>
                                    <div class="stat-value" x-text="stats.qcPassRate + '%'"></div>
                                    <div class="stat-label">QC Pass Rate</div>
                                </div>
                            </div>
                            <div class="grid-2">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-folder-open"></i> Recent Projects</h3>
                                        <button class="btn btn-secondary btn-sm" @click="navigate('projects')">View All</button>
                                    </div>
                                    <template x-if="recentProjects.length === 0">
                                        <div class="empty-state">
                                            <i class="fas fa-folder-open"></i>
                                            <h3>No projects yet</h3>
                                            <p>Create your first project to get started</p>
                                        </div>
                                    </template>
                                    <template x-for="project in recentProjects" :key="project.id">
                                        <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <div style="font-weight: 500;" x-text="project.title"></div>
                                                    <div style="font-size: 12px; color: var(--text-muted);" x-text="project.code"></div>
                                                </div>
                                                <span class="badge" :class="getStatusBadgeClass(project.status)" x-text="formatStatus(project.status)"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3>
                                    </div>
                                    <template x-for="activity in recentActivity" :key="activity.id">
                                        <div style="padding: 12px 0; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: flex-start;">
                                            <div style="width: 32px; height: 32px; border-radius: 8px; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center;">
                                                <i :class="getActivityIcon(activity.type)"></i>
                                            </div>
                                            <div>
                                                <div style="font-size: 13px;" x-text="activity.description"></div>
                                                <div style="font-size: 11px; color: var(--text-muted);" x-text="formatDateTime(activity.created_at)"></div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Projects Page -->
                    <template x-if="currentPage === 'projects'">
                        <div class="fade-in">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-flask"></i> All Projects</h3>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-secondary" @click="exportToExcel(projects, 'Projects')">
                                            <i class="fas fa-file-excel"></i> Export
                                        </button>
                                        <button class="btn btn-primary" @click="showModal = 'createProject'">
                                            <i class="fas fa-plus"></i> New Project
                                        </button>
                                    </div>
                                </div>
                                <!-- Search & Filter Toolbar -->
                                <div class="table-toolbar">
                                    <div class="search-box">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-input" x-model="projectSearch" placeholder="Search projects..." @input="filterProjects()">
                                    </div>
                                    <div class="toolbar-actions">
                                        <select class="form-select" style="width: auto;" x-model="projectStatusFilter" @change="filterProjects()">
                                            <option value="">All Status</option>
                                            <option value="draft">Draft</option>
                                            <option value="active">Active</option>
                                            <option value="completed">Completed</option>
                                            <option value="on_hold">On Hold</option>
                                        </select>
                                    </div>
                                </div>
                                <template x-if="isLoading">
                                    <!-- Skeleton Loading -->
                                    <div>
                                        <div class="skeleton skeleton-card" style="margin-bottom: 12px;"></div>
                                        <div class="skeleton skeleton-card" style="margin-bottom: 12px;"></div>
                                        <div class="skeleton skeleton-card"></div>
                                    </div>
                                </template>
                                <template x-if="!isLoading && filteredProjects.length === 0">
                                    <div class="empty-state">
                                        <i class="fas fa-flask"></i>
                                        <h3 x-text="projectSearch ? 'No matching projects' : 'No projects found'"></h3>
                                        <p x-text="projectSearch ? 'Try a different search term' : 'Create your first project to start your research'"></p>
                                        <button class="btn btn-primary" style="margin-top: 16px;" @click="showModal = 'createProject'" x-show="!projectSearch">
                                            <i class="fas fa-plus"></i> Create Project
                                        </button>
                                    </div>
                                </template>
                                <template x-if="!isLoading && filteredProjects.length > 0">
                                    <div>
                                        <div class="table-container">
                                            <table>
                                                <thead>
                                                <tr>
                                                    <th class="sortable" @click="sortTable('projects', 'code')">Code <i class="fas fa-sort sort-icon" :class="{ 'active': projectSort.field === 'code' }"></i></th>
                                                    <th class="sortable" @click="sortTable('projects', 'title')">Title <i class="fas fa-sort sort-icon" :class="{ 'active': projectSort.field === 'title' }"></i></th>
                                                    <th>Crop</th>
                                                    <th>Formulas</th>
                                                    <th class="sortable" @click="sortTable('projects', 'status')">Status <i class="fas fa-sort sort-icon" :class="{ 'active': projectSort.field === 'status' }"></i></th>
                                                    <th class="sortable" @click="sortTable('projects', 'created_at')">Created <i class="fas fa-sort sort-icon" :class="{ 'active': projectSort.field === 'created_at' }"></i></th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="project in paginatedProjects" :key="project.id">
                                                    <tr>
                                                        <td><span style="font-family: monospace; color: var(--primary-light);" x-text="project.code"></span></td>
                                                        <td x-text="project.title"></td>
                                                        <td x-text="project.crop_type || '-'"></td>
                                                        <td><span class="badge badge-info" x-text="(getProjectFormulas(project.id).length || 0) + ' formulas'"></span></td>
                                                        <td><span class="badge" :class="getStatusBadgeClass(project.status)" x-text="formatStatus(project.status)"></span></td>
                                                        <td x-text="formatDate(project.created_at)"></td>
                                                        <td style="white-space: nowrap;">
                                                            <button class="btn btn-primary btn-sm" @click="openProjectDetail(project)" title="View Details & Formulas"><i class="fas fa-folder-open"></i></button>
                                                            <button class="btn btn-secondary btn-sm" @click="editProject(project)" title="Edit"><i class="fas fa-edit"></i></button>
                                                            <button class="btn btn-secondary btn-sm" @click="generateProjectQR(project.id)" title="Generate QR"><i class="fas fa-qrcode"></i></button>
                                                            <button class="btn btn-danger btn-sm" @click="deleteProject(project)" title="Delete"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                        </div>
                                        <!-- Pagination -->
                                        <div class="pagination">
                                            <div class="pagination-info">
                                                Showing <span x-text="((projectPage - 1) * projectPageSize) + 1"></span> - <span x-text="Math.min(projectPage * projectPageSize, filteredProjects.length)"></span> of <span x-text="filteredProjects.length"></span> projects
                                            </div>
                                            <div class="pagination-controls">
                                                <select class="page-size-select" x-model="projectPageSize" @change="projectPage = 1">
                                                    <option value="5">5 per page</option>
                                                    <option value="10">10 per page</option>
                                                    <option value="25">25 per page</option>
                                                    <option value="50">50 per page</option>
                                                </select>
                                                <button class="pagination-btn" @click="projectPage--" :disabled="projectPage === 1"><i class="fas fa-chevron-left"></i></button>
                                                <template x-for="page in projectTotalPages" :key="page">
                                                    <button class="pagination-btn" :class="{ 'active': projectPage === page }" @click="projectPage = page" x-text="page" x-show="Math.abs(page - projectPage) < 3 || page === 1 || page === projectTotalPages"></button>
                                                </template>
                                                <button class="pagination-btn" @click="projectPage++" :disabled="projectPage >= projectTotalPages"><i class="fas fa-chevron-right"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Formulas Page -->
                    <template x-if="currentPage === 'formulas'">
                        <div class="fade-in">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-prescription-bottle"></i> Formulas</h3>
                                    <button class="btn btn-primary" @click="showModal = 'createFormula'">
                                        <i class="fas fa-plus"></i> New Formula
                                    </button>
                                </div>
                                <template x-if="isLoading">
                                    <div class="loading"><div class="spinner"></div></div>
                                </template>
                                <template x-if="!isLoading && formulas.length === 0">
                                    <div class="empty-state">
                                        <i class="fas fa-prescription-bottle"></i>
                                        <h3>No formulas found</h3>
                                        <p>Create your first formula to define product compositions</p>
                                        <button class="btn btn-primary" style="margin-top: 16px;" @click="showModal = 'createFormula'">
                                            <i class="fas fa-plus"></i> Create Formula
                                        </button>
                                    </div>
                                </template>
                                <template x-if="!isLoading && formulas.length > 0">
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr><th>Code</th><th>Name</th><th>Type</th><th>Status</th><th>Version</th><th>Actions</th></tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="formula in formulas" :key="formula.id">
                                                    <tr>
                                                        <td x-text="formula.code"></td>
                                                        <td x-text="formula.name"></td>
                                                        <td x-text="formula.formula_type || '-'"></td>
                                                        <td><span class="badge" :class="getStatusBadgeClass(formula.status)" x-text="formatStatus(formula.status)"></span></td>
                                                        <td x-text="'v' + formula.version"></td>
                                                        <td>
                                                            <button class="btn btn-secondary btn-sm" @click="viewFormula(formula)"><i class="fas fa-eye"></i></button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Lab Tests Page -->
                    <template x-if="currentPage === 'lab-tests'">
                        <div class="fade-in">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-vial"></i> Lab Tests</h3>
                                    <button class="btn btn-primary" @click="showModal = 'createLabTest'">
                                        <i class="fas fa-plus"></i> New Lab Test
                                    </button>
                                </div>
                                <template x-if="isLoading">
                                    <div class="loading"><div class="spinner"></div></div>
                                </template>
                                <template x-if="!isLoading && labTests.length === 0">
                                    <div class="empty-state">
                                        <i class="fas fa-vial"></i>
                                        <h3>No lab tests found</h3>
                                        <p>Create lab tests to record quality control results</p>
                                        <button class="btn btn-primary" style="margin-top: 16px;" @click="showModal = 'createLabTest'">
                                            <i class="fas fa-plus"></i> Create Lab Test
                                        </button>
                                    </div>
                                </template>
                                <template x-if="!isLoading && labTests.length > 0">
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr><th>Test ID</th><th>Formula</th><th>Test Type</th><th>Status</th><th>Date</th><th>Actions</th></tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="test in labTests" :key="test.id">
                                                    <tr>
                                                        <td x-text="test.id.substring(0,8)"></td>
                                                        <td x-text="test.formula_code || '-'"></td>
                                                        <td x-text="test.test_type"></td>
                                                        <td><span class="badge" :class="getStatusBadgeClass(test.status)" x-text="formatStatus(test.status)"></span></td>
                                                        <td x-text="formatDate(test.created_at)"></td>
                                                        <td>
                                                            <button class="btn btn-secondary btn-sm" @click="viewLabTest(test)"><i class="fas fa-eye"></i></button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Monitoring Page -->
                    <template x-if="currentPage === 'monitoring'">
                        <div class="fade-in">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-leaf"></i> Field Monitoring</h3>
                                    <button class="btn btn-primary" @click="showModal = 'createMonitoringSession'">
                                        <i class="fas fa-plus"></i> New Session
                                    </button>
                                </div>
                                <template x-if="isLoading">
                                    <div class="loading"><div class="spinner"></div></div>
                                </template>
                                <template x-if="!isLoading && monitoringSessions.length === 0">
                                    <div class="empty-state">
                                        <i class="fas fa-leaf"></i>
                                        <h3>No monitoring sessions</h3>
                                        <p>Start a monitoring session to collect field data</p>
                                        <button class="btn btn-primary" style="margin-top: 16px;" @click="showModal = 'createMonitoringSession'">
                                            <i class="fas fa-plus"></i> Start Session
                                        </button>
                                    </div>
                                </template>
                                <template x-if="!isLoading && monitoringSessions.length > 0">
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr><th>Session</th><th>Project</th><th>Block</th><th>Date</th><th>Status</th><th>Actions</th></tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="session in monitoringSessions" :key="session.id">
                                                    <tr>
                                                        <td x-text="session.id.substring(0,8)"></td>
                                                        <td x-text="session.project_code || '-'"></td>
                                                        <td x-text="session.block_code || '-'"></td>
                                                        <td x-text="formatDate(session.session_date)"></td>
                                                        <td><span class="badge" :class="session.completed_at ? 'badge-success' : 'badge-warning'" x-text="session.completed_at ? 'Completed' : 'In Progress'"></span></td>
                                                        <td>
                                                            <button class="btn btn-secondary btn-sm" @click="viewMonitoringSession(session)"><i class="fas fa-eye"></i></button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- QR Scanner Page -->
                    <template x-if="currentPage === 'qr-scanner'">
                        <div class="fade-in">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-qrcode"></i> QR Scanner</h3>
                                </div>
                                <div style="text-align: center; padding: 40px;">
                                    <div style="width: 200px; height: 200px; border: 2px dashed var(--border); border-radius: 16px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-camera" style="font-size: 48px; color: var(--text-muted);"></i>
                                    </div>
                                    <p style="color: var(--text-muted); margin-bottom: 20px;">Scan QR codes to quickly access blocks and units</p>
                                    <div class="form-group" style="max-width: 400px; margin: 0 auto;">
                                        <label class="form-label">Or enter QR code manually:</label>
                                        <div style="display: flex; gap: 8px;">
                                            <input type="text" class="form-input" x-model="qrInput" placeholder="Enter QR code...">
                                            <button class="btn btn-primary" @click="scanQRCode()">
                                                <i class="fas fa-search"></i> Lookup
                                            </button>
                                        </div>
                                    </div>
                                    <template x-if="qrResult">
                                        <div class="alert alert-info" style="max-width: 400px; margin: 20px auto;">
                                            <i class="fas fa-info-circle"></i>
                                            <span x-text="qrResult"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- AI Analysis Page -->
                    <template x-if="currentPage === 'analysis'">
                        <div class="fade-in">
                            <div class="grid-2">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-brain"></i> AI Analysis</h3>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Analysis Type</label>
                                        <select class="form-select" x-model="analysisType">
                                            <option value="descriptive">Descriptive Statistics</option>
                                            <option value="anova">ANOVA Analysis</option>
                                            <option value="cost-benefit">Cost-Benefit Analysis</option>
                                            <option value="ai">AI Insights</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Select Project</label>
                                        <select class="form-select" x-model="selectedProjectId">
                                            <option value="">Select a project...</option>
                                            <template x-for="project in projects" :key="project.id">
                                                <option :value="project.id" x-text="project.code + ' - ' + project.title"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ask AI (optional)</label>
                                        <textarea class="form-textarea" x-model="aiQuery" placeholder="Ask a question about your data..."></textarea>
                                    </div>
                                    <button class="btn btn-primary" @click="runAnalysis()" :disabled="isLoading || !selectedProjectId">
                                        <i class="fas fa-play" x-show="!isLoading"></i>
                                        <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                                        Run Analysis
                                    </button>
                                </div>
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> Results</h3>
                                    </div>
                                    <template x-if="!analysisResult">
                                        <div class="empty-state">
                                            <i class="fas fa-chart-pie"></i>
                                            <h3>No results yet</h3>
                                            <p>Run an analysis to see results here</p>
                                        </div>
                                    </template>
                                    <template x-if="analysisResult">
                                        <div>
                                            <pre style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 12px;" x-text="JSON.stringify(analysisResult, null, 2)"></pre>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Reports Page -->
                    <template x-if="currentPage === 'reports'">
                        <div class="fade-in">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-file-pdf"></i> Generate Report</h3>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Report Type</label>
                                        <select class="form-select" x-model="reportType">
                                            <option value="project_summary">Project Summary</option>
                                            <option value="experiment_report">Experiment Report</option>
                                            <option value="qc_report">QC Report</option>
                                            <option value="monitoring_report">Monitoring Report</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Select Project</label>
                                        <select class="form-select" x-model="reportProjectId">
                                            <option value="">Select a project...</option>
                                            <template x-for="project in projects" :key="project.id">
                                                <option :value="project.id" x-text="project.code + ' - ' + project.title"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Report Title</label>
                                    <input type="text" class="form-input" x-model="reportTitle" placeholder="Enter report title...">
                                </div>
                                <button class="btn btn-primary" @click="generateReport()" :disabled="isLoading || !reportProjectId">
                                    <i class="fas fa-file-export" x-show="!isLoading"></i>
                                    <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                                    Generate Report
                                </button>
                                <template x-if="reportResult">
                                    <div class="alert alert-success" style="margin-top: 20px;">
                                        <i class="fas fa-check-circle"></i>
                                        Report generated successfully!
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </main>

            <!-- Modals -->
            <!-- Create Project Modal -->
            <template x-if="showModal === 'createProject'">
                <div class="modal-overlay" @click.self="showModal = null">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Create New Project</h3>
                            <button class="modal-close" @click="showModal = null">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Project Code *</label>
                                    <input type="text" class="form-input" x-model="newProject.code" placeholder="e.g., PRJ-2026-001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Project Title *</label>
                                    <input type="text" class="form-input" x-model="newProject.title" placeholder="e.g., Biostimulant Efficacy Trial">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Crop Type</label>
                                    <input type="text" class="form-input" x-model="newProject.crop_type" placeholder="e.g., Rice, Corn, Soybean">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Crop Variety</label>
                                    <input type="text" class="form-input" x-model="newProject.crop_variety" placeholder="e.g., IR64">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Background</label>
                                <textarea class="form-textarea" x-model="newProject.background" placeholder="Research background and context..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Objectives</label>
                                <textarea class="form-textarea" x-model="newProject.objectives" placeholder="Research objectives..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Experiment Design</label>
                                    <select class="form-select" x-model="newProject.experiment_design">
                                        <option value="">Select design...</option>
                                        <option value="Rak">RAK (Randomized Complete Block)</option>
                                        <option value="Ral">RAL (Complete Randomized)</option>
                                        <option value="Factorial">Factorial</option>
                                        <option value="SplitPlot">Split Plot</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Replications</label>
                                    <input type="number" class="form-input" x-model="newProject.replications" placeholder="3">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-input" x-model="newProject.start_date">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-input" x-model="newProject.end_date">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-input" x-model="newProject.location_name" placeholder="e.g., Subang Research Station">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @click="showModal = null">Cancel</button>
                            <button class="btn btn-primary" @click="createProject()" :disabled="isLoading || !newProject.title || !newProject.code">
                                <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                                Create Project
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Create Formula Modal -->
            <template x-if="showModal === 'createFormula'">
                <div class="modal-overlay" @click.self="showModal = null">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Create New Formula</h3>
                            <button class="modal-close" @click="showModal = null">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Select Project *</label>
                                <select class="form-select" x-model="newFormula.project_id">
                                    <option value="">Select a project...</option>
                                    <template x-for="project in projects" :key="project.id">
                                        <option :value="project.id" x-text="project.code + ' - ' + project.title"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Formula Code *</label>
                                    <input type="text" class="form-input" x-model="newFormula.code" placeholder="e.g., FML-001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Formula Name *</label>
                                    <input type="text" class="form-input" x-model="newFormula.name" placeholder="e.g., Bio-NPK Plus">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" x-model="newFormula.description" placeholder="Formula description..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Application Method</label>
                                <input type="text" class="form-input" x-model="newFormula.application_method" placeholder="e.g., Foliar spray, Soil drench">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Application Rate</label>
                                    <input type="text" class="form-input" x-model="newFormula.application_rate" placeholder="e.g., 2 ml/L">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Target Crop</label>
                                    <input type="text" class="form-input" x-model="newFormula.target_crop" placeholder="e.g., Rice">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @click="showModal = null">Cancel</button>
                            <button class="btn btn-primary" @click="createFormula()" :disabled="isLoading || !newFormula.name || !newFormula.code || !newFormula.project_id">
                                <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                                Create Formula
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Create Lab Test Modal -->
            <template x-if="showModal === 'createLabTest'">
                <div class="modal-overlay" @click.self="showModal = null">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Create Lab Test</h3>
                            <button class="modal-close" @click="showModal = null">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Select Formula *</label>
                                <select class="form-select" x-model="newLabTest.formula_id">
                                    <option value="">Select a formula...</option>
                                    <template x-for="formula in formulas" :key="formula.id">
                                        <option :value="formula.id" x-text="formula.code + ' - ' + formula.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Test Type *</label>
                                <select class="form-select" x-model="newLabTest.test_type">
                                    <option value="">Select test type...</option>
                                    <option value="nutrient_analysis">Nutrient Analysis</option>
                                    <option value="microbial_count">Microbial Count</option>
                                    <option value="heavy_metal">Heavy Metal Test</option>
                                    <option value="ph_ec">pH & EC</option>
                                    <option value="stability">Stability Test</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sample ID</label>
                                <input type="text" class="form-input" x-model="newLabTest.sample_id" placeholder="Enter sample ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-textarea" x-model="newLabTest.notes" placeholder="Additional notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @click="showModal = null">Cancel</button>
                            <button class="btn btn-primary" @click="createLabTest()" :disabled="isLoading || !newLabTest.formula_id || !newLabTest.test_type">
                                <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                                Create Lab Test
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Create Monitoring Session Modal -->
            <template x-if="showModal === 'createMonitoringSession'">
                <div class="modal-overlay" @click.self="showModal = null">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Start Monitoring Session</h3>
                            <button class="modal-close" @click="showModal = null">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Select Project *</label>
                                <select class="form-select" x-model="newMonitoringSession.project_id">
                                    <option value="">Select a project...</option>
                                    <template x-for="project in projects" :key="project.id">
                                        <option :value="project.id" x-text="project.code + ' - ' + project.title"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Session Date</label>
                                    <input type="date" class="form-input" x-model="newMonitoringSession.session_date">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Days After Treatment</label>
                                    <input type="number" class="form-input" x-model="newMonitoringSession.days_after_treatment" placeholder="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Weather Conditions</label>
                                <select class="form-select" x-model="newMonitoringSession.weather_condition">
                                    <option value="">Select...</option>
                                    <option value="sunny">Sunny</option>
                                    <option value="cloudy">Cloudy</option>
                                    <option value="rainy">Rainy</option>
                                    <option value="partly_cloudy">Partly Cloudy</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-textarea" x-model="newMonitoringSession.notes" placeholder="Session notes..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @click="showModal = null">Cancel</button>
                            <button class="btn btn-primary" @click="createMonitoringSession()" :disabled="isLoading || !newMonitoringSession.project_id">
                                <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                                Start Session
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Project Detail Modal -->
            <template x-if="showModal === 'projectDetail' && selectedProject">
                <div class="modal-overlay" @click.self="showModal = null">
                    <div class="modal" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-flask" style="color: var(--primary);"></i> Project Details</h3>
                            <button class="modal-close" @click="showModal = null">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- Project Info -->
                            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <h4 style="margin-bottom: 8px;" x-text="selectedProject.title"></h4>
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; color: var(--text-muted);">
                                            <span><i class="fas fa-tag"></i> <span x-text="selectedProject.code"></span></span>
                                            <span><i class="fas fa-seedling"></i> <span x-text="selectedProject.crop_type || 'N/A'"></span></span>
                                            <span><i class="fas fa-leaf"></i> <span x-text="selectedProject.crop_variety || 'N/A'"></span></span>
                                            <span><i class="fas fa-calendar"></i> <span x-text="formatDate(selectedProject.created_at)"></span></span>
                                        </div>
                                    </div>
                                    <span class="badge" :class="getStatusBadgeClass(selectedProject.status)" x-text="formatStatus(selectedProject.status)"></span>
                                </div>
                                <template x-if="selectedProject.objectives">
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                        <strong style="font-size: 12px; color: var(--text-muted);">OBJECTIVES</strong>
                                        <p style="margin-top: 4px; font-size: 14px;" x-text="selectedProject.objectives"></p>
                                    </div>
                                </template>
                            </div>

                            <!-- Project Formulas Section -->
                            <div style="margin-top: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h4 style="font-size: 14px;"><i class="fas fa-prescription-bottle" style="color: var(--primary);"></i> Formulas for this Project</h4>
                                    <button class="btn btn-primary btn-sm" @click="addFormulaToProject()">
                                        <i class="fas fa-plus"></i> Add Formula
                                    </button>
                                </div>
                                <template x-if="projectFormulas.length === 0">
                                    <div style="text-align: center; padding: 30px; background: var(--bg-tertiary); border-radius: 8px; color: var(--text-muted);">
                                        <i class="fas fa-flask" style="font-size: 32px; opacity: 0.5; margin-bottom: 10px;"></i>
                                        <p>No formulas assigned to this project yet.</p>
                                        <button class="btn btn-secondary btn-sm" style="margin-top: 10px;" @click="addFormulaToProject()">
                                            <i class="fas fa-plus"></i> Create First Formula
                                        </button>
                                    </div>
                                </template>
                                <template x-if="projectFormulas.length > 0">
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr><th>Code</th><th>Name</th><th>Type</th><th>Status</th><th>Version</th><th>Actions</th></tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="formula in projectFormulas" :key="formula.id">
                                                    <tr>
                                                        <td><span style="font-family: monospace;" x-text="formula.code"></span></td>
                                                        <td x-text="formula.name"></td>
                                                        <td x-text="formula.formula_type || '-'"></td>
                                                        <td><span class="badge" :class="getStatusBadgeClass(formula.status)" x-text="formatStatus(formula.status)"></span></td>
                                                        <td x-text="'v' + (formula.version || 1)"></td>
                                                        <td>
                                                            <button class="btn btn-secondary btn-sm" @click="viewFormula(formula)"><i class="fas fa-eye"></i></button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @click="editProject(selectedProject)"><i class="fas fa-edit"></i> Edit Project</button>
                            <button class="btn btn-primary" @click="showModal = null">Close</button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Edit Project Modal -->
            <template x-if="showModal === 'editProject' && editingProject">
                <div class="modal-overlay" @click.self="showModal = null">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-edit" style="color: var(--primary);"></i> Edit Project</h3>
                            <button class="modal-close" @click="showModal = null">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Project Code</label>
                                    <input type="text" class="form-input" x-model="editingProject.code" disabled style="opacity: 0.6;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" x-model="editingProject.status">
                                        <option value="draft">Draft</option>
                                        <option value="active">Active</option>
                                        <option value="on_hold">On Hold</option>
                                        <option value="completed">Completed</option>
                                        <option value="archived">Archived</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Project Title *</label>
                                <input type="text" class="form-input" x-model="editingProject.title">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Crop Type</label>
                                    <input type="text" class="form-input" x-model="editingProject.crop_type">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Crop Variety</label>
                                    <input type="text" class="form-input" x-model="editingProject.crop_variety">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Objectives</label>
                                <textarea class="form-textarea" x-model="editingProject.objectives"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Experiment Design</label>
                                    <select class="form-select" x-model="editingProject.experiment_design">
                                        <option value="">Select design...</option>
                                        <option value="Rak">RAK (Randomized Complete Block)</option>
                                        <option value="Ral">RAL (Complete Randomized)</option>
                                        <option value="Factorial">Factorial</option>
                                        <option value="SplitPlot">Split Plot</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Replications</label>
                                    <input type="number" class="form-input" x-model="editingProject.replications">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-input" x-model="editingProject.location_name">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @click="showModal = null">Cancel</button>
                            <button class="btn btn-primary" @click="updateProject()" :disabled="isLoading || !editingProject.title">
                                <i class="fas fa-spinner fa-spin" x-show="isLoading"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </template>

            <!-- AI Chat -->
            <div class="chat-container">
                <template x-if="!chatOpen">
                    <button class="chat-toggle" @click="chatOpen = true">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                </template>
                <template x-if="chatOpen">
                    <div class="chat-window">
                        <div class="chat-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-robot" style="color: var(--primary);"></i>
                                <span style="font-weight: 600;">AI Research Assistant</span>
                            </div>
                            <button class="modal-close" @click="chatOpen = false">&times;</button>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <template x-for="msg in chatMessages" :key="msg.id">
                                <div class="chat-message" :class="msg.role">
                                    <div class="bubble" x-text="msg.content"></div>
                                </div>
                            </template>
                            <template x-if="chatMessages.length === 0">
                                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    <i class="fas fa-robot" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                                    <p>Hi! I'm your AI research assistant. Ask me anything about your R&D data.</p>
                                </div>
                            </template>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" class="form-input" x-model="chatInput" @keyup.enter="sendChatMessage()" placeholder="Type a message...">
                            <button class="btn btn-primary" @click="sendChatMessage()" :disabled="!chatInput || isChatLoading">
                                <i class="fas fa-paper-plane" x-show="!isChatLoading"></i>
                                <i class="fas fa-spinner fa-spin" x-show="isChatLoading"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <script>
        // ================== TOAST NOTIFICATION SYSTEM ==================
        const Toast = {
            container: null,
            init() {
                this.container = document.getElementById('toastContainer');
            },
            show(type, title, message, duration = 5000) {
                if (!this.container) this.init();
                const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <i class="fas ${icons[type]} toast-icon"></i>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
                `;
                this.container.appendChild(toast);
                setTimeout(() => toast.remove(), duration);
            },
            success(title, msg) { this.show('success', title, msg); },
            error(title, msg) { this.show('error', title, msg); },
            warning(title, msg) { this.show('warning', title, msg); },
            info(title, msg) { this.show('info', title, msg); }
        };

        function app() {
            return {
                isAuthenticated: false, isLoading: false, loginError: '',
                credentials: { email: '', password: '' }, user: {},
                currentPage: 'dashboard', sidebarOpen: false, showModal: null, chatOpen: false,
                stats: { activeProjects: 0, pendingQC: 0, observations: 0, qcPassRate: 0 },
                recentProjects: [], recentActivity: [], projects: [], formulas: [], labTests: [], monitoringSessions: [],
                newProject: {}, newFormula: {}, newLabTest: {},
                newMonitoringSession: { session_date: new Date().toISOString().split('T')[0] },
                editingProject: null, selectedProject: null, projectFormulas: [],
                analysisType: 'descriptive', selectedProjectId: '', aiQuery: '', analysisResult: null,
                reportType: 'project_summary', reportProjectId: '', reportTitle: '', reportResult: null,
                qrInput: '', qrResult: '',
                chatMessages: [], chatInput: '', isChatLoading: false,
                apiBase: '/api/v1',
                
                // Pagination & Filtering State
                projectSearch: '', projectStatusFilter: '', filteredProjects: [],
                projectPage: 1, projectPageSize: 10,
                projectSort: { field: 'created_at', direction: 'desc' },

                async init() {
                    const token = localStorage.getItem('access_token');
                    if (token) { this.isAuthenticated = true; await this.loadUserData(); await this.loadDashboardData(); }
                },

                get pageTitle() {
                    return { dashboard: 'Dashboard', projects: 'Projects', formulas: 'Formulas', 'lab-tests': 'Lab Tests',
                        monitoring: 'Field Monitoring', 'qr-scanner': 'QR Scanner', analysis: 'AI Analysis', reports: 'Reports' }[this.currentPage] || 'Dashboard';
                },
                
                // Computed: Paginated projects for current page
                get paginatedProjects() {
                    const start = (this.projectPage - 1) * this.projectPageSize;
                    return this.filteredProjects.slice(start, start + parseInt(this.projectPageSize));
                },
                
                // Computed: Total pages for projects
                get projectTotalPages() {
                    return Math.ceil(this.filteredProjects.length / this.projectPageSize) || 1;
                },

                // Filter projects based on search and status
                filterProjects() {
                    let result = [...this.projects];
                    // Apply search filter
                    if (this.projectSearch) {
                        const search = this.projectSearch.toLowerCase();
                        result = result.filter(p => 
                            (p.title && p.title.toLowerCase().includes(search)) ||
                            (p.code && p.code.toLowerCase().includes(search)) ||
                            (p.crop_type && p.crop_type.toLowerCase().includes(search))
                        );
                    }
                    // Apply status filter
                    if (this.projectStatusFilter) {
                        result = result.filter(p => p.status === this.projectStatusFilter);
                    }
                    // Apply sorting
                    result.sort((a, b) => {
                        let aVal = a[this.projectSort.field] || '';
                        let bVal = b[this.projectSort.field] || '';
                        if (this.projectSort.field === 'created_at') {
                            aVal = new Date(aVal).getTime();
                            bVal = new Date(bVal).getTime();
                        }
                        if (this.projectSort.direction === 'asc') return aVal > bVal ? 1 : -1;
                        return aVal < bVal ? 1 : -1;
                    });
                    this.filteredProjects = result;
                    this.projectPage = 1; // Reset to first page when filtering
                },
                
                // Sort table
                sortTable(table, field) {
                    if (table === 'projects') {
                        if (this.projectSort.field === field) {
                            this.projectSort.direction = this.projectSort.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.projectSort.field = field;
                            this.projectSort.direction = 'asc';
                        }
                        this.filterProjects();
                    }
                },
                
                // Export to Excel
                exportToExcel(data, filename) {
                    if (!data || data.length === 0) {
                        Toast.warning('No Data', 'No data available to export');
                        return;
                    }
                    try {
                        // Prepare data for export (flatten objects)
                        const exportData = data.map(item => ({
                            Code: item.code || '',
                            Title: item.title || item.name || '',
                            Type: item.crop_type || item.formula_type || item.test_type || '',
                            Status: item.status || '',
                            Created: item.created_at ? new Date(item.created_at).toLocaleDateString() : '',
                            Description: item.objectives || item.description || ''
                        }));
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, filename);
                        XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
                        Toast.success('Export Successful', `${data.length} records exported to Excel`);
                    } catch (e) {
                        Toast.error('Export Failed', e.message);
                    }
                },

                async navigate(page) {
                    this.currentPage = page; this.sidebarOpen = false;
                    if (page === 'projects') await this.loadProjects();
                    else if (page === 'formulas') await this.loadFormulas();
                    else if (page === 'lab-tests') await this.loadLabTests();
                    else if (page === 'monitoring') await this.loadMonitoringSessions();
                    else if (page === 'analysis' || page === 'reports') await this.loadProjects();
                },

                async login() {
                    this.isLoading = true; this.loginError = '';
                    try {
                        const res = await fetch(`${this.apiBase}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.credentials) });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.message || 'Login failed');
                        localStorage.setItem('access_token', data.access_token); localStorage.setItem('refresh_token', data.refresh_token);
                        this.user = data.user; this.isAuthenticated = true; 
                        Toast.success('Welcome!', `Logged in as ${data.user.full_name || data.user.email}`);
                        await this.loadDashboardData();
                    } catch (e) { this.loginError = e.message; Toast.error('Login Failed', e.message); }
                    this.isLoading = false;
                },

                logout() { 
                    localStorage.removeItem('access_token'); 
                    localStorage.removeItem('refresh_token'); 
                    this.isAuthenticated = false; 
                    this.user = {}; 
                    this.credentials = { email: '', password: '' }; 
                    Toast.info('Logged Out', 'You have been logged out successfully');
                },

                async apiCall(endpoint, method = 'GET', body = null) {
                    const token = localStorage.getItem('access_token');
                    const opts = { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } };
                    if (body) opts.body = JSON.stringify(body);
                    const res = await fetch(`${this.apiBase}${endpoint}`, opts);
                    if (res.status === 401) { this.logout(); throw new Error('Session expired'); }
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'API error');
                    return data;
                },

                async loadUserData() { try { const res = await this.apiCall('/auth/me'); this.user = res.data; } catch (e) { console.error(e); } },

                async loadDashboardData() {
                    try {
                        const projectsRes = await this.apiCall('/projects');
                        this.projects = projectsRes.data || [];
                        this.recentProjects = this.projects.slice(0, 5);
                        this.stats = { activeProjects: this.projects.filter(p => p.status === 'active').length || this.projects.length, pendingQC: 2, observations: 1284, qcPassRate: 87 };
                        this.recentActivity = [
                            { id: '1', type: 'qc', description: 'Lab test completed', created_at: new Date() },
                            { id: '2', type: 'monitoring', description: 'Field data collected', created_at: new Date(Date.now() - 3600000) },
                            { id: '3', type: 'project', description: 'New project created', created_at: new Date(Date.now() - 7200000) },
                        ];
                    } catch (e) { console.error(e); }
                },

                async loadProjects() { 
                    this.isLoading = true; 
                    try { 
                        const res = await this.apiCall('/projects'); 
                        this.projects = res.data || []; 
                        this.filterProjects(); // Apply filtering
                        // Load formulas for all projects
                        await this.loadAllFormulas();
                    } catch (e) { console.error(e); Toast.error('Load Failed', 'Could not load projects'); } 
                    this.isLoading = false; 
                },
                async loadAllFormulas() {
                    try {
                        const res = await this.apiCall('/formulas');
                        this.formulas = res.data || [];
                    } catch (e) { console.error(e); this.formulas = []; }
                },
                async loadFormulas() { 
                    this.isLoading = true; 
                    try {
                        const res = await this.apiCall('/formulas');
                        this.formulas = res.data || [];
                    } catch (e) { console.error(e); this.formulas = []; }
                    this.isLoading = false; 
                },
                async loadProjectFormulas(projectId) {
                    try {
                        // Filter formulas by project_id
                        return this.formulas.filter(f => f.project_id === projectId);
                    } catch (e) { console.error(e); return []; }
                },
                getProjectFormulas(projectId) {
                    return this.formulas.filter(f => f.project_id === projectId);
                },
                async loadLabTests() { this.isLoading = true; this.labTests = []; this.isLoading = false; },
                async loadMonitoringSessions() { this.isLoading = true; this.monitoringSessions = []; this.isLoading = false; },

                async createProject() {
                    this.isLoading = true;
                    try { 
                        await this.apiCall('/projects', 'POST', this.newProject); 
                        this.showModal = null; 
                        Toast.success('Project Created', `Project "${this.newProject.title}" created successfully`);
                        this.newProject = {}; 
                        await this.loadProjects(); 
                    }
                    catch (e) { Toast.error('Error', e.message); }
                    this.isLoading = false;
                },

                async createFormula() {
                    this.isLoading = true;
                    try {
                        // Add empty ingredients array if not present
                        const formulaData = { ...this.newFormula, ingredients: this.newFormula.ingredients || [] };
                        await this.apiCall('/formulas', 'POST', formulaData);
                        Toast.success('Formula Created', `Formula "${this.newFormula.name}" created successfully`);
                        this.showModal = null; this.newFormula = {}; await this.loadFormulas();
                    }
                    catch (e) { Toast.error('Error', e.message); }
                    this.isLoading = false;
                },

                async createLabTest() {
                    this.isLoading = true;
                    try { 
                        await this.apiCall('/lab-tests', 'POST', this.newLabTest); 
                        Toast.success('Lab Test Created', 'Lab test created successfully');
                        this.showModal = null; this.newLabTest = {}; await this.loadLabTests(); 
                    }
                    catch (e) { Toast.error('Error', e.message); }
                    this.isLoading = false;
                },

                async createMonitoringSession() {
                    this.isLoading = true;
                    try { 
                        await this.apiCall('/monitoring/sessions', 'POST', this.newMonitoringSession); 
                        Toast.success('Session Started', 'Monitoring session started successfully');
                        this.showModal = null; this.newMonitoringSession = { session_date: new Date().toISOString().split('T')[0] }; await this.loadMonitoringSessions(); 
                    }
                    catch (e) { Toast.error('Error', e.message); }
                    this.isLoading = false;
                },

                // Project Detail & Edit Functions
                async openProjectDetail(project) {
                    this.selectedProject = project;
                    this.projectFormulas = this.getProjectFormulas(project.id);
                    this.showModal = 'projectDetail';
                },
                editProject(project) {
                    this.editingProject = { ...project };
                    this.showModal = 'editProject';
                },
                async updateProject() {
                    this.isLoading = true;
                    try {
                        await this.apiCall(`/projects/${this.editingProject.id}`, 'PUT', this.editingProject);
                        Toast.success('Project Updated', 'Project updated successfully');
                        this.showModal = null;
                        this.editingProject = null;
                        await this.loadProjects();
                    } catch (e) { Toast.error('Error', e.message); }
                    this.isLoading = false;
                },
                async deleteProject(project) {
                    if (!confirm(`Are you sure you want to delete project "${project.title}"?\n\nThis action cannot be undone.`)) return;
                    this.isLoading = true;
                    try {
                        await this.apiCall(`/projects/${project.id}`, 'DELETE');
                        Toast.success('Project Deleted', `Project "${project.title}" has been deleted`);
                        await this.loadProjects();
                    } catch (e) { alert('Error: ' + e.message); }
                    this.isLoading = false;
                },
                viewProject(project) { this.openProjectDetail(project); },
                viewFormula(formula) { 
                    Toast.info('Formula Details', `${formula.name} (${formula.code})\nStatus: ${formula.status || 'Draft'}`); 
                },
                viewLabTest(test) { Toast.info('Lab Test', test.test_type); },
                viewMonitoringSession(session) { Toast.info('Monitoring Session', `Session ID: ${session.id.substring(0,8)}`); },
                async addFormulaToProject() {
                    if (!this.selectedProject) return;
                    this.newFormula = { project_id: this.selectedProject.id };
                    this.showModal = 'createFormula';
                },

                async generateProjectQR(projectId) { 
                    try { 
                        await this.apiCall(`/projects/${projectId}/qr-codes`, 'POST', {}); 
                        Toast.success('QR Generated', 'QR codes generated successfully!'); 
                    } catch (e) { 
                        Toast.error('QR Error', e.message); 
                    } 
                },

                async scanQRCode() { if (!this.qrInput) return; try { const res = await this.apiCall('/qr/scan', 'POST', { qr_data: this.qrInput }); this.qrResult = 'Found: ' + JSON.stringify(res.data); Toast.success('QR Found', 'Item located successfully'); } catch (e) { this.qrResult = 'Not found or invalid QR code'; Toast.warning('QR Not Found', 'Invalid or unknown QR code'); } },

                async runAnalysis() {
                    this.isLoading = true;
                    try { 
                        const res = await this.apiCall('/analysis/' + this.analysisType, 'POST', { project_id: this.selectedProjectId, query: this.aiQuery }); 
                        this.analysisResult = res.data || res; 
                        Toast.success('Analysis Complete', 'Analysis results ready');
                    }
                    catch (e) { this.analysisResult = { error: e.message }; Toast.error('Analysis Error', e.message); }
                    this.isLoading = false;
                },

                async generateReport() {
                    this.isLoading = true;
                    try { 
                        const res = await this.apiCall('/reports/generate', 'POST', { report_type: this.reportType, project_id: this.reportProjectId, title: this.reportTitle || 'Report' }); 
                        this.reportResult = res; 
                        Toast.success('Report Generated', 'Your report is ready');
                    }
                    catch (e) { Toast.error('Report Error', e.message); }
                    this.isLoading = false;
                },

                async sendChatMessage() {
                    if (!this.chatInput || this.isChatLoading) return;
                    this.chatMessages.push({ id: Date.now(), role: 'user', content: this.chatInput });
                    const userMessage = this.chatInput; this.chatInput = ''; this.isChatLoading = true;
                    try {
                        const res = await this.apiCall('/ai/chat', 'POST', { message: userMessage, context_types: ['projects', 'formulas'] });
                        // Handle various response formats from backend
                        const aiResponse = res.data?.response || res.data?.response_alias || res.data?.answer || res.response || res.answer || 'I could not process that request.';
                        this.chatMessages.push({ id: Date.now() + 1, role: 'ai', content: aiResponse });
                    } catch (e) { 
                        this.chatMessages.push({ id: Date.now() + 1, role: 'ai', content: 'Sorry, I encountered an error: ' + e.message }); 
                    }
                    this.isChatLoading = false;
                    this.$nextTick(() => { const el = document.getElementById('chatMessages'); if (el) el.scrollTop = el.scrollHeight; });
                },

                formatDate(d) { if (!d) return '-'; return new Date(d).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' }); },
                formatDateTime(d) { if (!d) return '-'; return new Date(d).toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); },
                formatStatus(s) { return { draft: 'Draft', active: 'Active', completed: 'Completed', pending_qc: 'Pending QC', qc_passed: 'QC Passed', qc_failed: 'QC Failed', on_hold: 'On Hold', archived: 'Archived', pending: 'Pending', in_progress: 'In Progress' }[s] || s; },
                formatRole(r) { return { system_admin: 'System Admin', SystemAdmin: 'System Admin', rd_manager: 'R&D Manager', RdManager: 'R&D Manager', principal_researcher: 'Researcher', PrincipalResearcher: 'Researcher', qc_analyst: 'QC Analyst', QcAnalyst: 'QC Analyst', field_officer: 'Field Officer', FieldOfficer: 'Field Officer' }[r] || r; },
                getStatusBadgeClass(s) { return { draft: 'badge-info', active: 'badge-primary', completed: 'badge-success', pending_qc: 'badge-warning', qc_passed: 'badge-success', qc_failed: 'badge-danger', on_hold: 'badge-warning', archived: 'badge-info', pending: 'badge-warning', in_progress: 'badge-info' }[s] || 'badge-info'; },
                getActivityIcon(t) { return { project: 'fas fa-flask', formula: 'fas fa-prescription-bottle', qc: 'fas fa-vial', monitoring: 'fas fa-leaf' }[t] || 'fas fa-circle'; }
            };
        }
    </script>
</body>
</html>